// AlgoTrack - –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î
// Multi-tenant —Å–∏—Å—Ç–µ–º–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —à–∫–æ–ª

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TEACHER
}

enum ParentType {
  CALM       // üü¢ –°–ø–æ–∫–æ–π–Ω—ã–π
  ANXIOUS    // üü° –¢—Ä–µ–≤–æ–∂–Ω—ã–π
  DEMANDING  // üî¥ –¢—Ä–µ–±–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π
}

enum ActivityLevel {
  LOW
  MEDIUM
  HIGH
}

enum Mood {
  HAPPY      // üòä
  THINKING   // ü§î
  TIRED      // üò¥
  DISTRACTED // üòï
}

enum MessageStatus {
  PENDING
  QUEUED
  PROCESSING
  SENT
  FAILED
  CANCELLED
}

enum ReportStatus {
  DRAFT
  GENERATED
  SENT
}

enum MessageType {
  LESSON_SUMMARY      // –û–° –ø–æ—Å–ª–µ —É—Ä–æ–∫–∞ (–≤ –≥—Ä—É–ø–ø—É)
  PERSONAL_REPORT     // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –û–° (–≤ –õ–°)
}

// ============================================
// SUPER ADMIN (–í–´ - –≥–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
// ============================================

model SuperAdmin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // bcrypt hash
  name      String
  phone     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("super_admins")
}

// ============================================
// –®–ö–û–õ–´ (Multi-tenancy)
// ============================================

model School {
  id                    String   @id @default(cuid())
  name                  String   // "–ê–ª–≥–æ—Ä–∏—Ç–º–∏–∫–∞ –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫"
  city                  String   // "–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫"
  timezone              String   @default("Asia/Vladivostok")
  logoUrl               String?  @map("logo_url")
  
  // WhatsApp (GreenAPI)
  greenApiInstanceId    String?  @map("greenapi_instance_id")
  greenApiToken         String?  @map("greenapi_token")
  greenApiInstanceId2   String?  @map("greenapi_instance_id_2") // –†–µ–∑–µ—Ä–≤–Ω—ã–π
  greenApiToken2        String?  @map("greenapi_token_2")       // –†–µ–∑–µ—Ä–≤–Ω—ã–π
  
  // AI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  aiProvider            String   @default("openai") // –°—Å—ã–ª–∫–∞ –Ω–∞ AiProviderConfig.name
  aiApiKey              String?  @map("ai_api_key") // –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π API –∫–ª—é—á —à–∫–æ–ª—ã
  
  // Rate limiting –¥–ª—è –∞–Ω—Ç–∏–±–∞–Ω–∞
  maxMessagesPerMinute  Int      @default(5) @map("max_messages_per_minute")
  maxMessagesPerHour    Int      @default(100) @map("max_messages_per_hour")
  delayBetweenMessages  Int      @default(20) @map("delay_between_messages") // —Å–µ–∫—É–Ω–¥—ã
  
  isActive              Boolean  @default(true) @map("is_active")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  admins                Admin[]
  teachers              Teacher[]
  classes               Class[]
  students              Student[]
  
  @@map("schools")
}

// ============================================
// AI –ü–†–û–í–ê–ô–î–ï–†–´ (–ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
// ============================================

model AiProviderConfig {
  id              String   @id @default(cuid())
  name            String   @unique  // "gigachat", "openai", "openrouter"
  displayName     String   // "GigaChat (–°–±–µ—Ä)", "OpenAI (ChatGPT)"
  apiUrl          String   @map("api_url")
  authType        String   @map("auth_type")   // "bearer", "apikey", "oauth"
  
  // JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  authConfig      Json     @map("auth_config")      // { apiKey?, authKey?, tokenUrl? }
  requestFormat   Json     @map("request_format")   // { method, headers, bodyTemplate }
  responseMapping Json     @map("response_mapping") // { contentPath, errorPath }
  modelConfig     Json     @map("model_config")     // { model, temperature, maxTokens }
  
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("ai_provider_configs")
}

// ============================================
// –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò
// ============================================

// –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —à–∫–æ–ª—ã
model Admin {
  id        String   @id @default(cuid())
  schoolId  String   @map("school_id")
  email     String   @unique
  password  String   // bcrypt hash
  name      String
  phone     String?
  avatar    String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  @@index([schoolId])
  @@map("admins")
}

// –£—á–∏—Ç–µ–ª—å
model Teacher {
  id        String   @id @default(cuid())
  schoolId  String   @map("school_id")
  email     String   @unique
  password  String   // bcrypt hash
  name      String
  phone     String?
  avatar    String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes   Class[]
  
  @@index([schoolId])
  @@map("teachers")
}

// ============================================
// –°–¢–†–£–ö–¢–£–†–ê –û–ë–£–ß–ï–ù–ò–Ø
// ============================================

// –ö–ª–∞—Å—Å (–ì—Ä—É–ø–ø–∞)
model Class {
  id                String   @id @default(cuid())
  schoolId          String   @map("school_id")
  teacherId         String   @map("teacher_id")
  name              String   // "Python –ù–∞—á–∏–Ω–∞—é—â–∏–µ 10:00"
  description       String?
  
  // WhatsApp –≥—Ä—É–ø–ø–∞
  whatsappGroupId   String?  @map("whatsapp_group_id")   // 79991234567-1234567890@g.us
  whatsappGroupName String?  @map("whatsapp_group_name") // "Python –ù–∞—á–∏–Ω–∞—é—â–∏–µ"
  whatsappGroupLink String?  @map("whatsapp_group_link") // –°—Å—ã–ª–∫–∞ –∏–∑ –≤–µ–± –≤–µ—Ä—Å–∏–∏
  
  // –ö—Ç–æ —Å–æ–∑–¥–∞–ª
  createdBy         String   @map("created_by")      // ID —É—á–∏—Ç–µ–ª—è –∏–ª–∏ –∞–¥–º–∏–Ω–∞
  createdByType     UserRole @map("created_by_type") // TEACHER –∏–ª–∏ ADMIN
  
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  school            School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher           Teacher  @relation(fields: [teacherId], references: [id])
  students          ClassStudent[]
  lessons           Lesson[]
  
  @@index([schoolId])
  @@index([teacherId])
  @@map("classes")
}

// –£—á–µ–Ω–∏–∫
model Student {
  id                String     @id @default(cuid())
  schoolId          String     @map("school_id")
  name              String     // "–ò–≤–∞–Ω–æ–≤ –ü–µ—Ç—Ä"
  avatar            String?
  
  // –†–æ–¥–∏—Ç–µ–ª—å
  parentName        String     @map("parent_name")  // "–ò–≤–∞–Ω–æ–≤–∞ –ú–∞—Ä–∏—è"
  parentPhone       String     @map("parent_phone") // "+79991234567"
  parentType        ParentType @default(CALM) @map("parent_type")
  
  // –¢–æ–∫–µ–Ω –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–æ–¥–∏—Ç–µ–ª—è
  parentToken       String     @unique @default(cuid()) @map("parent_token")
  
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")

  school            School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes           ClassStudent[]
  lessonCards       LessonCard[]
  personalReports   PersonalReport[]
  
  @@index([schoolId])
  @@index([parentToken])
  @@map("students")
}

// –°–≤—è–∑—å –∫–ª–∞—Å—Å-—É—á–µ–Ω–∏–∫ (many-to-many)
model ClassStudent {
  id        String   @id @default(cuid())
  classId   String   @map("class_id")
  studentId String   @map("student_id")
  createdAt DateTime @default(now()) @map("created_at")

  class    Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  student  Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@unique([classId, studentId])
  @@index([classId])
  @@index([studentId])
  @@map("class_students")
}

// ============================================
// –£–†–û–ö–ò –ò –ö–ê–†–¢–û–ß–ö–ò
// ============================================

// –£—Ä–æ–∫
model Lesson {
  id                String   @id @default(cuid())
  classId           String   @map("class_id")
  lessonNumber      Int      @map("lesson_number") // 1, 2, 3, 4...
  lessonDate        DateTime @map("lesson_date")
  topic             String?  // "–¶–∏–∫–ª—ã –≤ Python"
  topicForAi        String?  @map("topic_for_ai") @db.Text // –û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  class             Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  cards             LessonCard[]
  summary           LessonSummary?
  
  @@unique([classId, lessonNumber])
  @@index([classId])
  @@map("lessons")
}

// –ö–∞—Ä—Ç–æ—á–∫–∞ —É—á–µ–Ω–∏–∫–∞ –Ω–∞ —É—Ä–æ–∫–µ
model LessonCard {
  id                String        @id @default(cuid())
  lessonId          String        @map("lesson_id")
  studentId         String        @map("student_id")
  
  completionPercent Int           @map("completion_percent") // 0-100%
  activityLevel     ActivityLevel @map("activity_level")
  mood              Mood
  whatWorked        String?       @map("what_worked")  @db.Text
  toImprove         String?       @map("to_improve")   @db.Text
  homework          String?       @db.Text
  notes             String?       @db.Text
  
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  lesson            Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student           Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@unique([lessonId, studentId])
  @@index([lessonId])
  @@index([studentId])
  @@map("lesson_cards")
}

// ============================================
// –°–û–û–ë–©–ï–ù–ò–Ø –ò –û–¢–ß–Å–¢–´
// ============================================

// –û–° –ø–æ—Å–ª–µ —É—Ä–æ–∫–∞ (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –≥—Ä—É–ø–ø—É)
model LessonSummary {
  id                String        @id @default(cuid())
  lessonId          String        @unique @map("lesson_id")
  
  teacherName       String        @map("teacher_name")     // –ò–º—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
  content           String        @db.Text                 // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
  nextLessonDate    DateTime?     @map("next_lesson_date") // –î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–∫–∞
  
  status            MessageStatus @default(PENDING)
  scheduledAt       DateTime?     @map("scheduled_at")     // –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
  sentAt            DateTime?     @map("sent_at")
  
  // WhatsApp
  whatsappMessageId String?       @map("whatsapp_message_id")
  whatsappError     String?       @map("whatsapp_error") @db.Text
  
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  lesson            Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@index([status, scheduledAt])
  @@map("lesson_summaries")
}

// –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –û–° (–ø–æ—Å–ª–µ 4 —É—Ä–æ–∫–æ–≤)
model PersonalReport {
  id                String       @id @default(cuid())
  studentId         String       @map("student_id")
  
  fromLesson        Int          @map("from_lesson") // 1
  toLesson          Int          @map("to_lesson")   // 4
  content           String       @db.Text
  
  // PDF
  pdfUrl            String?      @map("pdf_url")
  pdfGenerated      Boolean      @default(false) @map("pdf_generated")
  
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  avgCompletion     Float        @map("avg_completion")
  hasAbsences       Boolean      @default(false) @map("has_absences")
  
  status            ReportStatus @default(DRAFT)
  generatedAt       DateTime?    @map("generated_at")
  sentAt            DateTime?    @map("sent_at")
  
  // WhatsApp
  whatsappMessageId String?      @map("whatsapp_message_id")
  whatsappError     String?      @map("whatsapp_error") @db.Text
  
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  student           Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@index([studentId])
  @@index([status])
  @@map("personal_reports")
}

// ============================================
// –û–ß–ï–†–ï–î–¨ –°–û–û–ë–©–ï–ù–ò–ô (–¥–ª—è –∞–Ω—Ç–∏–±–∞–Ω–∞)
// ============================================

model MessageQueue {
  id                String        @id @default(cuid())
  schoolId          String        @map("school_id")
  
  type              MessageType
  recipientType     String        @map("recipient_type") // "group" / "personal"
  recipientId       String        @map("recipient_id")   // chatId WhatsApp
  
  content           String        @db.Text
  fileUrl           String?       @map("file_url")
  
  status            MessageStatus @default(PENDING)
  priority          String        @default("normal")     // "normal" / "high"
  
  scheduledAt       DateTime      @map("scheduled_at")
  sentAt            DateTime?     @map("sent_at")
  
  attempts          Int           @default(0)
  lastError         String?       @map("last_error") @db.Text
  
  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  lessonSummaryId   String?       @map("lesson_summary_id")
  personalReportId  String?       @map("personal_report_id")
  
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  
  @@index([status, scheduledAt])
  @@index([schoolId])
  @@map("message_queue")
}

// ============================================
// –õ–û–ì–ò –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì
// ============================================

model ErrorLog {
  id        String   @id @default(cuid())
  schoolId  String?  @map("school_id")
  type      String   // "WHATSAPP_BAN", "AI_ERROR", etc
  error     String   @db.Text
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([schoolId])
  @@index([type])
  @@map("error_logs")
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  userType  UserRole @map("user_type")
  action    String   // "CREATE_CLASS", "SEND_MESSAGE", etc
  entity    String   // "Class", "Student", etc
  entityId  String?  @map("entity_id")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([action])
  @@map("activity_logs")
}

